<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">

    <meta name="author" content="Gazettm">





<title>CSAPP_链接_1 | Gazettm&#39;s Blog</title>



    <link rel="icon" href="/favicon.ico">




    <!-- stylesheets list from _config.yml -->
    
    <link rel="stylesheet" href="/css/style.css">
    



    <!-- scripts list from _config.yml -->
    
    <script src="/js/script.js"></script>
    
    <script src="/js/tocbot.min.js"></script>
    



    
    
        
    


<meta name="generator" content="Hexo 7.3.0"></head>

<body>
    <script>
        // this function is used to check current theme before page loaded.
        (() => {
            const currentTheme = window.localStorage && window.localStorage.getItem('theme') || '';
            const isDark = currentTheme === 'dark';
            const pagebody = document.getElementsByTagName('body')[0]
            if (isDark) {
                pagebody.classList.add('dark-theme');
                // mobile
                document.getElementById("mobile-toggle-theme").innerText = "· Dark"
            } else {
                pagebody.classList.remove('dark-theme');
                // mobile
                document.getElementById("mobile-toggle-theme").innerText = "· Light"
            }
        })();
    </script>

    <div class="wrapper">
        <header>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-header header-logo"><a href="/">Gazettm&#39;s Blog</a></div>
            <div class="menu navbar-right">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/categories">Categories</a>
                
                    <a class="menu-item" href="/tags">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
                <input id="switch_default" type="checkbox" class="switch_default">
                <label for="switch_default" class="toggleBtn"></label>
            </div>
        </div>
    </nav>

    
    <nav class="navbar-mobile" id="nav-mobile">
        <div class="container">
            <div class="navbar-header">
                <div>
                    <a href="/">Gazettm&#39;s Blog</a><a id="mobile-toggle-theme">·&nbsp;Light</a>
                </div>
                <div class="menu-toggle" onclick="mobileBtn()">&#9776; Menu</div>
            </div>
            <div class="menu" id="mobile-menu">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/categories">Categories</a>
                
                    <a class="menu-item" href="/tags">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
            </div>
        </div>
    </nav>

</header>
<script>
    var mobileBtn = function f() {
        var toggleMenu = document.getElementsByClassName("menu-toggle")[0];
        var mobileMenu = document.getElementById("mobile-menu");
        if(toggleMenu.classList.contains("active")){
           toggleMenu.classList.remove("active")
            mobileMenu.classList.remove("active")
        }else{
            toggleMenu.classList.add("active")
            mobileMenu.classList.add("active")
        }
    }
</script>
            <div class="main">
                <div class="container">
    
    
        <div class="post-toc">
    <div class="tocbot-list">
    </div>
    <div class="tocbot-list-menu">
        <a class="tocbot-toc-expand" onclick="expand_toc()">Expand all</a>
        <a onclick="go_top()">Back to top</a>
        <a onclick="go_bottom()">Go to bottom</a>
    </div>
</div>

<script>
    var tocbot_timer;
    var DEPTH_MAX = 6; // 为 6 时展开所有
    var tocbot_default_config = {
        tocSelector: '.tocbot-list',
        contentSelector: '.post-content',
        headingSelector: 'h1, h2, h3, h4, h5',
        orderedList: false,
        scrollSmooth: true,
        onClick: extend_click,
    };

    function extend_click() {
        clearTimeout(tocbot_timer);
        tocbot_timer = setTimeout(function() {
            tocbot.refresh(obj_merge(tocbot_default_config, {
                hasInnerContainers: true
            }));
        }, 420); // 这个值是由 tocbot 源码里定义的 scrollSmoothDuration 得来的
    }

    document.ready(function() {
        tocbot.init(obj_merge(tocbot_default_config, {
            collapseDepth: 1
        }));
    });

    function expand_toc() {
        var b = document.querySelector('.tocbot-toc-expand');
        var expanded = b.getAttribute('data-expanded');
        expanded ? b.removeAttribute('data-expanded') : b.setAttribute('data-expanded', true);
        tocbot.refresh(obj_merge(tocbot_default_config, {
            collapseDepth: expanded ? 1 : DEPTH_MAX
        }));
        b.innerText = expanded ? 'Expand all' : 'Collapse all';
    }

    function go_top() {
        window.scrollTo(0, 0);
    }

    function go_bottom() {
        window.scrollTo(0, document.body.scrollHeight);
    }

    function obj_merge(target, source) {
        for (var item in source) {
            if (source.hasOwnProperty(item)) {
                target[item] = source[item];
            }
        }
        return target;
    }
</script>
    

    
    <article class="post-wrap">
        <header class="post-header">
            <h1 class="post-title">CSAPP_链接_1</h1>
            
                <div class="post-meta">
                    
                        Author: <a itemprop="author" rel="author" href="/">Gazettm</a>
                    

                    
                        <span class="post-time">
                        Date: <a href="#">十二月 4, 2025&nbsp;&nbsp;13:52:09</a>
                        </span>
                    
                    
                        <span class="post-category">
                    Category:
                            
                                <a href="/categories/CSAPP/">CSAPP</a>
                            
                        </span>
                    
                </div>
            
        </header>

        <div class="post-content">
            <h1 id="CSAPP链接-1"><a href="#CSAPP链接-1" class="headerlink" title="CSAPP链接_1"></a>CSAPP链接_1</h1><h2 id="编译器驱动程序"><a href="#编译器驱动程序" class="headerlink" title="编译器驱动程序"></a>编译器驱动程序</h2><p><code>main.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">sum</span><span class="params">(<span class="type">int</span> *a, <span class="type">int</span> n)</span>;</span><br><span class="line"><span class="type">int</span> <span class="built_in">array</span>[<span class="number">2</span>] = &#123;<span class="number">1</span>,<span class="number">2</span>&#125;;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">	<span class="type">int</span> val = sum(<span class="built_in">array</span>, <span class="number">2</span>);</span><br><span class="line">	<span class="keyword">return</span> val;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>sum.c</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">int sum(int *a, int n)&#123;</span><br><span class="line">	int i ,s = 0;</span><br><span class="line">	for(i = 0;i &lt; n;i++)</span><br><span class="line">		s += a[i];</span><br><span class="line">	return s;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>对于这样一个程序，使用</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc -Og -o prog main.c sum.c</span><br></pre></td></tr></table></figure>

<p>可以编译为可执行文件。</p>
<p>我们了解，在把源代码变为可执行文件的过程中，有四个步骤。<strong>预处理</strong>，<strong>编译</strong>，<strong>汇编</strong>，<strong>链接</strong></p>
<h3 id="预处理"><a href="#预处理" class="headerlink" title="预处理"></a>预处理</h3><p>使用</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cpp -o main.i main.c</span><br></pre></td></tr></table></figure>

<p>或者</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc -E -o main.i main.c</span><br></pre></td></tr></table></figure>

<p>可以进行预处理。</p>
<p>得到内容</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"># 0 &quot;&lt;built-in&gt;&quot;</span><br><span class="line"># 0 &quot;&lt;command-line&gt;&quot;</span><br><span class="line"># 1 &quot;/usr/include/stdc-predef.h&quot; 1 3 4</span><br><span class="line"># 0 &quot;&lt;command-line&gt;&quot; 2</span><br><span class="line"># 1 &quot;main.c&quot;</span><br><span class="line">int sum(int *a, int n);</span><br><span class="line">int array[2] = &#123;1,2&#125;;</span><br><span class="line">int main()&#123;</span><br><span class="line"> int val = sum(array, 2);</span><br><span class="line"> return val;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="编译"><a href="#编译" class="headerlink" title="编译"></a>编译</h3><p>使用以下命令可以进行编译。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cc -S -o main.s main.i</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc -S -o main.s main.i</span><br></pre></td></tr></table></figure>

<p>内容如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">	.file	&quot;main.c&quot;</span><br><span class="line">	.text</span><br><span class="line">	.globl	array</span><br><span class="line">	.data</span><br><span class="line">	.align 8</span><br><span class="line">	.type	array, @object</span><br><span class="line">	.size	array, 8</span><br><span class="line">array:</span><br><span class="line">	.long	1</span><br><span class="line">	.long	2</span><br><span class="line">	.text</span><br><span class="line">	.globl	main</span><br><span class="line">	.type	main, @function</span><br><span class="line">main:</span><br><span class="line">.LFB0:</span><br><span class="line">	.cfi_startproc</span><br><span class="line">	pushq	%rbp</span><br><span class="line">	.cfi_def_cfa_offset 16</span><br><span class="line">	.cfi_offset 6, -16</span><br><span class="line">	movq	%rsp, %rbp</span><br><span class="line">	.cfi_def_cfa_register 6</span><br><span class="line">	subq	$16, %rsp</span><br><span class="line">	movl	$2, %esi</span><br><span class="line">	leaq	array(%rip), %rax</span><br><span class="line">	movq	%rax, %rdi</span><br><span class="line">	call	sum@PLT</span><br><span class="line">	movl	%eax, -4(%rbp)</span><br><span class="line">	movl	-4(%rbp), %eax</span><br><span class="line">	leave</span><br><span class="line">	.cfi_def_cfa 7, 8</span><br><span class="line">	ret</span><br><span class="line">	.cfi_endproc</span><br><span class="line">.LFE0:</span><br><span class="line">	.size	main, .-main</span><br><span class="line">	.ident	&quot;GCC: (Debian 14.2.0-19) 14.2.0&quot;</span><br><span class="line">	.section	.note.GNU-stack,&quot;&quot;,@progbits</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="汇编"><a href="#汇编" class="headerlink" title="汇编"></a>汇编</h3><p>使用以下指令进行汇编</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">as -o main.o main.s</span><br></pre></td></tr></table></figure>

<p>这里得到的<code>main.o</code>是可重定位目标文件，是二进制的，不可以直接查看</p>
<h3 id="链接"><a href="#链接" class="headerlink" title="链接"></a>链接</h3><p>在手动调用连接器来构造可执行程序的时候，除了要用到main.o 和 sum.o 之外，还需要用到以下五个文件</p>
<p><code>crt1.o</code> <code>crti.o</code> <code>crtbeginT.o</code> <code>crtend.o</code> <code>crtn.o</code></p>
<p>其中<code>crt</code>为c runtime的缩写。链接将这些文件打包成一个可执行文件。</p>
<p>使用以下指令手动静态链接。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ld -static -o prog main.o sum.o \</span><br><span class="line">/usr/lib/x86_64-linux-gnu/crt1.o \</span><br><span class="line">/usr/lib/x86_64-linux-gnu/crti.o \</span><br><span class="line">/usr/lib/gcc/x86_64-linux-gnu/14/crtbeginT.o \</span><br><span class="line">-L/usr/lib/gcc/x86_64-linux-gnu/14 \</span><br><span class="line">-L/usr/lib \</span><br><span class="line">--start-group -lgcc -lgcc_eh -lc --end-group \</span><br><span class="line">/usr/lib/gcc/x86_64-linux-gnu/14/crtend.o \</span><br><span class="line">/usr/lib/x86_64-linux-gnu/crtn.o</span><br></pre></td></tr></table></figure>

<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>关于链接就是将可重定位目标文件以及必要的系统文件组合起来生成一个可执行目标文件的操作。</p>
<h2 id="可重定位目标文件"><a href="#可重定位目标文件" class="headerlink" title="可重定位目标文件"></a>可重定位目标文件</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> count = <span class="number">10</span>;</span><br><span class="line"><span class="type">int</span> value;</span><br><span class="line"><span class="type">void</span> <span class="title function_">func</span> <span class="params">(<span class="type">int</span> sum)</span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;sum is:%d\n&quot;</span>,sum);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">static</span> <span class="type">int</span> a = <span class="number">1</span>;</span><br><span class="line">    <span class="type">static</span> <span class="type">int</span> b = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> x = <span class="number">1</span>;</span><br><span class="line">    func(a + b + x);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>对于这样的一个c代码，我们使用以下指令生成一个可重定位目标文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc -c main.c</span><br></pre></td></tr></table></figure>

<p>我们可以使用<code>wc</code>指令来查看<code>main.o</code>文件的大小。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># wc -c main.o                                      </span></span><br><span class="line">1760 main.o</span><br></pre></td></tr></table></figure>

<p>可以看到包含了1896个字节</p>
<p>每个可重定位目标文件包含三个部分</p>
<table>
<thead>
<tr>
<th>ELF header</th>
<th>Sections</th>
<th>Section header table</th>
</tr>
</thead>
</table>
<p>分别是<code>ELF header</code>，<code>Sections</code>和描述<code>Sections</code>信息的 <code>Section header table</code></p>
<p>ELF:Executable and Linkable Format（可执行可链接格式）</p>
<h3 id="ELF-Header"><a href="#ELF-Header" class="headerlink" title="ELF Header"></a>ELF Header</h3><p>使用如下指令查看<code>ELF header</code>的具体内容</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">readelf -h main.o </span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">ELF Header：</span><br><span class="line">  Magic：  7f 45 4c 46 02 01 01 00 00 00 00 00 00 00 00 00 </span><br><span class="line">  Class:                             ELF64</span><br><span class="line">  Data:                              2&#x27;s complement (little endian)</span><br><span class="line">  Version:                           1 (current)</span><br><span class="line">  OS/ABI:                            UNIX - System V</span><br><span class="line">  ABI Version:                       0</span><br><span class="line">  Type:                              REL (Relocatable file)</span><br><span class="line">  Machine:                           Advanced Micro Devices X86-64</span><br><span class="line">  Version:                           0x1</span><br><span class="line">  Entry point address：              0x0</span><br><span class="line">  Start of program headers：         0 (bytes into file)</span><br><span class="line">  Start of section headers:          928 (bytes into file)</span><br><span class="line">  Flags：                            0x0</span><br><span class="line">  Size of this header:               64 (bytes)</span><br><span class="line">  Size of program headers:           0 (bytes)</span><br><span class="line">  Number of program headers:         0</span><br><span class="line">  Size of section headers:           64 (bytes)</span><br><span class="line">  Number of section headers:         13</span><br><span class="line">  Section header string table index: 12</span><br></pre></td></tr></table></figure>

<p>接下来我们详细解释ELF Header中的信息。</p>
<ul>
<li><code>7f 45 4c 46 02 01 01 00 00 00 00 00 00 00 00 00</code> 前面四个字节<code>7f 45 4c 46</code>被称为ELF文件的魔数，与ASCII码的DEL控制符，字符中的E，L，F对应。</li>
<li>接下来一个字节02表示64位，若为01则表示32位。</li>
<li>第六个字节表示字节序，01表示小端序，02表示大端序。</li>
<li>第七个字节表示ELF文件的版本号，通常都是1。</li>
<li>最后的九个字节无实际意义，用0填充。</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Type:                              REL (Relocatable file)</span><br></pre></td></tr></table></figure>

<p>这一行表示该文件类型位可重定位文件，还有两种文件类型分别是可执行文件和共享文件。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Size of this header:               64 (bytes)</span><br></pre></td></tr></table></figure>

<p>这里给出了这个Header的长度位64个字节。于是我们可以确定<code>Sections</code>在elf文件中的起始位置是0x40。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Start of section headers:          928 (bytes into file)</span><br></pre></td></tr></table></figure>

<p>通过这一行信息，我们可以确定描述<code>Sections</code>信息的表的起始位置在928个字节。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Number of section headers:         13</span><br></pre></td></tr></table></figure>

<p>这个表示该表一共包含13个表项。每个表项的大小是</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Size of section headers:           64 (bytes)</span><br></pre></td></tr></table></figure>

<p>64个字节，于是我们呢可以算出来整个表的大小在64*13 &#x3D; 832个字节。928+832 &#x3D; 1760，符合wc指令查看到的字节数。</p>
<h3 id="Section-Header"><a href="#Section-Header" class="headerlink" title="Section Header"></a>Section Header</h3><p>使用以下指令查看<code>Section Header</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">readelf -S main.o</span><br></pre></td></tr></table></figure>

<p>内容如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">There are 13 section headers, starting at offset 0x3a0:</span><br><span class="line"></span><br><span class="line">Section Header：</span><br><span class="line">  [Nr] Name              Type             Address           Offset</span><br><span class="line">       Size              EntSize          Flags  Link Info   Align</span><br><span class="line">  [ 0]                   NULL             0000000000000000  00000000</span><br><span class="line">       0000000000000000  0000000000000000           0     0     0</span><br><span class="line">  [ 1] .text             PROGBITS         0000000000000000  00000040</span><br><span class="line">       0000000000000057  0000000000000000  AX       0     0     1</span><br><span class="line">  [ 2] .rela.text        RELA             0000000000000000  00000290</span><br><span class="line">       0000000000000078  0000000000000018   I      10     1     8</span><br><span class="line">  [ 3] .data             PROGBITS         0000000000000000  00000098</span><br><span class="line">       0000000000000008  0000000000000000  WA       0     0     4</span><br><span class="line">  [ 4] .bss              NOBITS           0000000000000000  000000a0</span><br><span class="line">       0000000000000008  0000000000000000  WA       0     0     4</span><br><span class="line">  [ 5] .rodata           PROGBITS         0000000000000000  000000a0</span><br><span class="line">       000000000000000b  0000000000000000   A       0     0     1</span><br><span class="line">  [ 6] .comment          PROGBITS         0000000000000000  000000ab</span><br><span class="line">       0000000000000020  0000000000000001  MS       0     0     1</span><br><span class="line">  [ 7] .note.GNU-stack   PROGBITS         0000000000000000  000000cb</span><br><span class="line">       0000000000000000  0000000000000000           0     0     1</span><br><span class="line">  [ 8] .eh_frame         PROGBITS         0000000000000000  000000d0</span><br><span class="line">       0000000000000058  0000000000000000   A       0     0     8</span><br><span class="line">  [ 9] .rela.eh_frame    RELA             0000000000000000  00000308</span><br><span class="line">       0000000000000030  0000000000000018   I      10     8     8</span><br><span class="line">  [10] .symtab           SYMTAB           0000000000000000  00000128</span><br><span class="line">       0000000000000138  0000000000000018          11     8     8</span><br><span class="line">  [11] .strtab           STRTAB           0000000000000000  00000260</span><br><span class="line">       000000000000002d  0000000000000000           0     0     1</span><br><span class="line">  [12] .shstrtab         STRTAB           0000000000000000  00000338</span><br><span class="line">       0000000000000061  0000000000000000           0     0     1</span><br><span class="line">Key to Flags:</span><br><span class="line">  W (write), A (alloc), X (execute), M (merge), S (strings), I (info),</span><br><span class="line">  L (link order), O (extra OS processing required), G (group), T (TLS),</span><br><span class="line">  C (compressed), x (unknown), o (OS specific), E (exclude),</span><br><span class="line">  D (mbind), l (large), p (processor specific)</span><br></pre></td></tr></table></figure>

<p>该表除了第一项，其余每一表项都对应着一个<code>section</code>。</p>
<ul>
<li><code>offset</code>表示每个<code>section</code>的起始位置</li>
<li><code>size</code>表示<code>section</code>的大小</li>
</ul>
<p>根据这两个参数信息，我们就可以确定每个<code>section</code>在<code>elf</code>文件中的大小。</p>
<h4 id="text"><a href="#text" class="headerlink" title=".text"></a><code>.text</code></h4><p><code>.text</code>段的<code>offset</code>是0x40，上面我们得到ELF大小是64，也就是该段紧跟在ELF header之后。</p>
<p>该<code>section</code>中存放的是已经编译好的机器代码。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Contents of section .text:</span><br><span class="line"> 0000 554889e5 4883ec10 897dfc8b 45fc89c6  UH..H....&#125;..E...</span><br><span class="line"> 0010 488d0500 00000048 89c7b800 000000e8  H......H........</span><br><span class="line"> 0020 00000000 90c9c355 4889e548 83ec10c7  .......UH..H....</span><br><span class="line"> 0030 45fc0100 00008b15 00000000 8b050000  E...............</span><br><span class="line"> 0040 000001c2 8b45fc01 d089c7e8 00000000  .....E..........</span><br><span class="line"> 0050 b8000000 00c9c3                      .......</span><br></pre></td></tr></table></figure>

<h4 id="data"><a href="#data" class="headerlink" title=".data"></a><code>.data</code></h4><p><code>.text</code>段的大小是0x57，所以之后的<code>Section</code>是<code>.data</code>，<code>offset</code>是0x98。</p>
<p>该<code>section</code>中用来存放已初始化的全局变量和静态变量的值。</p>
<p>例如程序中我们为你将全局变量<code>count</code>初始化为10，静态变量<code>a</code>初始化为1。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Contents of section .data:</span><br><span class="line"> 0000 0a000000 01000000                    ........</span><br></pre></td></tr></table></figure>

<h4 id="bss"><a href="#bss" class="headerlink" title=".bss"></a><code>.bss</code></h4><p><code>.data</code>的大小为0x8，之后的<code>offset</code>为a0。我们可以看见有两个section的起始位置都是0xa0，这实际上是因为<code>.bss</code>的<code>type</code>为<code>NOBITS</code>，表示不占用空间，仅为占位符。在链接的时候才会分配内存，由于仅为占位，所以我们看不到<code>Contents of section .bss</code>的信息。</p>
<p>该<code>section</code>存放的是未初始化的全局变量和静态变量。被初始化为零的全局变量和静态变量也存放在该<code>section</code>中。</p>
<p><code>.bss</code>这个<code>section</code>并不占用实际的空间，仅仅只是一个占位符。区分已初始化和未初始化是为了节省空间，当程序运行时会在内存中分配这些变量并把初始值设置成0。</p>
<p>例如</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="built_in">array</span>[<span class="number">10000</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"><span class="type">int</span> <span class="built_in">array</span>[<span class="number">10000</span>];       </span><br></pre></td></tr></table></figure>

<p>如果全部放在<code>.data</code>段，需要存储40000个0在文件中。实际放在<code>.bss</code>段，文件中只记录”需要40000字节”。大大节省了空间。</p>
<h4 id="rodata"><a href="#rodata" class="headerlink" title=".rodata"></a><code>.rodata</code></h4><p><code>.data</code>之后是<code>.rodata</code>表示read only data。为只读数据。例如<code>printf</code>语句中的格式串与<code>switch</code>语句中的跳转表就是存放在该区域。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Contents of section .rodata:</span><br><span class="line"> 0000 73756d20 69733a25 640a00             sum is:%d..</span><br></pre></td></tr></table></figure>

<h4 id="Other"><a href="#Other" class="headerlink" title="Other"></a>Other</h4><p>对于剩余的<code>Section</code>的内容，内容如下</p>
<table>
<thead>
<tr>
<th>Section</th>
<th>Introduction</th>
</tr>
</thead>
<tbody><tr>
<td>.comment</td>
<td>存放的是编译器的版本信息</td>
</tr>
<tr>
<td>.symtab</td>
<td>Symbol Table，符号表</td>
</tr>
<tr>
<td>.rel.text</td>
<td>Relocation Table，重定位表</td>
</tr>
<tr>
<td>.debug</td>
<td>调试信息。</td>
</tr>
<tr>
<td>.line</td>
<td>原C程序的行号和.text section中机器指令的映射</td>
</tr>
<tr>
<td>.strtab</td>
<td>String Table， 字符串表</td>
</tr>
</tbody></table>
<h2 id="符号与符号表"><a href="#符号与符号表" class="headerlink" title="符号与符号表"></a>符号与符号表</h2><h3 id="符号表"><a href="#符号表" class="headerlink" title="符号表"></a>符号表</h3><p>我们重点看一下<code>.symtab</code>的详细内容。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">readelf -s main.o</span><br></pre></td></tr></table></figure>

<p>内容如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Symbol table &#x27;.symtab&#x27; contains 13 entries:</span><br><span class="line">   Num:    Value          Size Type    Bind   Vis      Ndx Name</span><br><span class="line">     0: 0000000000000000     0 NOTYPE  LOCAL  DEFAULT  UND </span><br><span class="line">     1: 0000000000000000     0 FILE    LOCAL  DEFAULT  ABS main.c</span><br><span class="line">     2: 0000000000000000     0 SECTION LOCAL  DEFAULT    1 .text</span><br><span class="line">     3: 0000000000000000     0 SECTION LOCAL  DEFAULT    3 .data</span><br><span class="line">     4: 0000000000000000     0 SECTION LOCAL  DEFAULT    4 .bss</span><br><span class="line">     5: 0000000000000000     0 SECTION LOCAL  DEFAULT    5 .rodata</span><br><span class="line">     6: 0000000000000004     4 OBJECT  LOCAL  DEFAULT    3 a.1</span><br><span class="line">     7: 0000000000000004     4 OBJECT  LOCAL  DEFAULT    4 b.0</span><br><span class="line">     8: 0000000000000000     4 OBJECT  GLOBAL DEFAULT    3 count</span><br><span class="line">     9: 0000000000000000     4 OBJECT  GLOBAL DEFAULT    4 value</span><br><span class="line">    10: 0000000000000000    39 FUNC    GLOBAL DEFAULT    1 func</span><br><span class="line">    11: 0000000000000000     0 NOTYPE  GLOBAL DEFAULT  UND printf</span><br><span class="line">    12: 0000000000000027    48 FUNC    GLOBAL DEFAULT    1 main</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>我们先看符号<code>main</code>和<code>func</code>，由于这两个为函数，在<code>Type</code>中表示为<code>FUNC</code>，同时也为全局定义的，所以表示的<code>Bind</code>为<code>GLOBAL</code>。<code>Ndx</code>表示的是section的索引值，我们可以查看上面说到的<code>table</code>来查看。<code>Ndx</code>为1，表示<code>main</code>和<code>func</code>存放在<code>.text</code>这个<code>section</code>中，Value表示函数相对于<code>.text</code> section其实位置的偏移量。<code>Size</code>表示所占字节数。通过途中信息我们发现函数<code>func</code>是从0开始的，大小是39个字节，因此<code>main</code>的偏移量为0x27。<code>Vis</code>在C语言中未使用，可以忽略。关于<code>printf</code>符号，虽然也是一个函数，但是在<code>main.c</code>中未定义，只是在<code>main.c</code>中被使用，因此这里显示的是<code>UND</code>。</p>
<p>关于全局变量<code>count</code>和<code>value</code>，定义的类型是<code>OBJECT</code>表示该符号是一个数据对象。虽然两者都是全局变量，但是两者的<code>Ndx</code>不同，原因是<code>count</code>经过初始化，在<code>.data</code> section中，而<code>value</code>位于<code>common</code>中，<code>common</code>属于<code>.bss</code>的一部分。两者的主要区别主要是：<code>common</code>存放未初始化的全局变量，<code>.bss</code>用来存放未初始化的静态变量，初始化为0的全局或静态变量</p>
<p>关于局部静态变量<code>a</code>和<code>b</code>，<code>Bind</code>表示为<code>LOCAl</code>，<code>a</code>的<code>Ndx</code>为3，与<code>count</code>相同，而<code>b</code>的<code>Ndx</code>为4，因为<code>b</code>未初始化。相对于原来的变量名，<code>a</code>变为了<code>a.1</code>，<code>b</code>变为了<code>b.0</code>，这种处理方式被称为名称修饰，为了防止静态变量冲突。</p>
<p>关于原本的main函数中，还定义了一个int类型的x变量，但是在此处并未出现。因为局部变量在运行时在栈中被管理，链接器对此类符号不感兴趣。局部变量的信息并不会出现在此处。</p>
<h3 id="符号"><a href="#符号" class="headerlink" title="符号"></a>符号</h3><p>符号被分为三种</p>
<ul>
<li><p>Global Symbols 全局符号</p>
<p>比如main.c中定义的函数func和全局变量count和value。</p>
</li>
<li><p>Externals Symbols 外部符号</p>
<p>比如printf，未定义，从外面引用的符号。</p>
</li>
<li><p>Local Symbols 局部符号</p>
<p>只能被该模块定义和使用的为局部符号 static属性的函数和变量不能被其它模块引用。对于C语言来说，static属性的功能就是隐藏模块内部的变量以及函数声明。</p>
</li>
</ul>
<h2 id="符号解析与静态库"><a href="#符号解析与静态库" class="headerlink" title="符号解析与静态库"></a>符号解析与静态库</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">foo</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    foo();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>对于这样一段代码，编译和汇编都是没问题的。当编译器遇到未在该模块中定义的函数时，会假设该函数在其他模块中定义。不过在链接时，在其他模块中找不到该函数的定义，会发生报错。</p>
<h3 id="强符号与弱符号"><a href="#强符号与弱符号" class="headerlink" title="强符号与弱符号"></a>强符号与弱符号</h3><p>强符号： 函数和已初始化的全局变量</p>
<p>若符号：未初始化的全局变量</p>
<p>注意：强符号和弱符号都是全局变量，此处静态变量与局部变量既非强符号也非弱符号。</p>
<h4 id="Rule"><a href="#Rule" class="headerlink" title="Rule"></a>Rule</h4><ul>
<li>出现多次强符号，发生报错</li>
<li>强符号与多个弱符号出现，选择强符号。</li>
<li>多个弱符号同时出现，任选一个</li>
</ul>
<h3 id="静态库"><a href="#静态库" class="headerlink" title="静态库"></a>静态库</h3><p>以ISO C99为例。</p>
<p>例如<code>atoi</code>，<code>printf</code>，<code>scanf</code>，<code>strcpy</code>，<code>rand</code>函数，都在<code>libc.a</code>的库中。</p>
<p>对于后缀为<code>.a</code>的文件，表示为<code>archive</code>，是一种成为存档的特殊文件格式，他是一组可重定位目标文件的集合。我们可以解压这种文件，看到所有的可重定位文件。</p>
<p>当我们想构造自己的静态库的时候，可以使用如下指令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ar rcs libvector.a addvec.o mulvec.o</span><br></pre></td></tr></table></figure>

<p>这样可以生成一个<code>libvector.a</code>的静态库，包含重定位文件<code>addvec.o</code>和<code>mulvec.o</code>。</p>
<p>在我们进行编译的时候，可以使用</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc -static -o prog main.o ./libvector.a</span><br></pre></td></tr></table></figure>

<p>这样可以使用自己构造的静态库。</p>

        </div>

        
            <section class="post-copyright">
                
                    <p class="copyright-item">
                        <span>Author:</span>
                        <span>Gazettm</span>
                    </p>
                
                
                    <p class="copyright-item">
                        <span>Permalink:</span>
                        <span><a href="http://gazettm.github.io/2025/12/04/CSAPP-%E9%93%BE%E6%8E%A5-1/">http://gazettm.github.io/2025/12/04/CSAPP-%E9%93%BE%E6%8E%A5-1/</a></span>
                    </p>
                
                
                

            </section>
        
        <section class="post-tags">
            <div>
                <span>Tag(s):</span>
                <span class="tag">
                    
                    
                        <a href="/tags/CSAPP/"># CSAPP</a>
                    
                        
                </span>
            </div>
            <div>
                <a href="javascript:window.history.back();">back</a>
                <span>· </span>
                <a href="/">home</a>
            </div>
        </section>
        <section class="post-nav">
            
            
            <a class="next" rel="next" href="/2025/11/25/CSAPP%E4%BC%98%E5%8C%96%E7%A8%8B%E5%BA%8F%E6%80%A7%E8%83%BD-2/">CSAPP优化程序性能_2</a>
            
        </section>


    </article>
</div>

            </div>
            <footer id="footer" class="footer">
    <div class="copyright">
        <span>© Gazettm | Powered by <a href="https://hexo.io" target="_blank">Hexo</a> & <a href="https://github.com/Siricee/hexo-theme-Chic" target="_blank">Chic</a></span>
    </div>
</footer>

    </div>
</body>

</html>